"ElbSecurityGroup": {
  "Type": "AWS::EC2::SecurityGroup",
  "Properties": {
    "GroupDescription": "Seattle AWS Meetup ELB Security Group",
    "VpcId": {
      "Ref": "AwsMeetupVpc"
    },
    "SecurityGroupIngress": [{
      "IpProtocol": "tcp",
      "FromPort": "80",
      "ToPort": "80",
      "CidrIp": "0.0.0.0/0"
    }, {
      "IpProtocol": "tcp",
      "FromPort": "1024",
      "ToPort": "65355",
      "CidrIp": "10.0.0.0/16"
    }],
    "Tags": [{
      "Key": "Name",
      "Value": "Seattle AWS Meetup ELB Security Group"
    }]
  }
},
"WebAutoScalingGroup": {
  "Type": "AWS::AutoScaling::AutoScalingGroup",
  "Properties": {
    "AvailabilityZones": [{
      "Ref": "ParamAvailabilityZone1"
    }, {
      "Ref": "ParamAvailabilityZone2"
    }],
    "VPCZoneIdentifier": [{
      "Ref": "SubnetPrivate1"
    }, {
      "Ref": "SubnetPrivate2"
    }],
    "LaunchConfigurationName": {
      "Ref": "LaunchConfig"
    },
    "MinSize": "2",
    "MaxSize": "2",
    "LoadBalancerNames": [{
      "Ref": "ElasticLoadBalancer"
    }],
    "MetricsCollection": [{
      "Granularity": "1Minute",
      "Metrics": [
        "GroupMinSize",
        "GroupMaxSize"
      ]
    }],
    "Tags": [{
      "Key": "Name",
      "Value": "Seattle AWS Meetup Autoscaling Instance",
      "PropagateAtLaunch": "true"
    }]

  }

},
"ElbLogBucket": {
  "Type": "AWS::S3::Bucket",
  "Properties": {
    "BucketName": {"Ref": "LogBucketName" }
  }
},
"ElbLogBucketPolicy": {
  "Type": "AWS::S3::BucketPolicy",
  "Properties": {
    "Bucket": {
      "Ref": "ElbLogBucket"
    },
    "PolicyDocument": {
      "Id": "ElbLogBucketPolicy",
      "Version": "2012-10-17",
      "Statement": [{
        "Sid": "uses-generic-ELB-arn",
        "Action": [
          "s3:PutObject"
        ],
        "Effect": "Allow",
        "Resource": {
          "Fn::Join": ["", [
            "arn:aws:s3:::",
            { "Ref": "LogBucketName" },
            "/AWSLogs/",
            { "Ref": "AWS::AccountId"},
            "/*"
          ]]
        },
        "Principal": {
          "AWS": [
            "797873946194"
          ]
        }
      }]
    }
  }
},
"ElasticLoadBalancer": {
  "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
  "Properties": {
    "AccessLoggingPolicy": {
      "EmitInterval": 5,
      "Enabled": "true",
      "S3BucketName": {
        "Ref": "ElbLogBucket"
      }
    },
    "Subnets": [{
      "Ref": "SubnetPublic1"
    }, {
      "Ref": "SubnetPublic2"
    }],
    "SecurityGroups": [{
      "Ref": "ElbSecurityGroup"
    }],
    "Listeners": [{
      "LoadBalancerPort": "80",
      "InstancePort": "80",
      "Protocol": "HTTP"
    }],
    "HealthCheck": {
      "Target": "HTTP:80/",
      "HealthyThreshold": "3",
      "UnhealthyThreshold": "5",
      "Interval": "30",
      "Timeout": "5"
    },
    "ConnectionDrainingPolicy": {
      "Enabled": "true",
      "Timeout": "60"
    },
    "Tags": [{
      "Key": "Name",
      "Value": "Seattle AWS Meetup ELB"
    }]
  }
},
"LaunchConfig": {
  "Type": "AWS::AutoScaling::LaunchConfiguration",
  "Properties": {
    "KeyName": {
      "Ref": "ParamKeyName"
    },
    "ImageId": "ami-b63210f3",
    "SecurityGroups": [{
      "Ref": "WebServerSecurityGroup"
    }],
    "InstanceType": "t2.micro",
    "EbsOptimized": "false",
    "UserData": {
      "Fn::Base64": {
        "Fn::Join": ["", [
          "#!/bin/bash -e\n",
          " yum install httpd \n",
          " chkconfig httpd on \n",
          " /etc/init.d/httpd start \n"
        ]]
      }
    }
  }
},
"WebServerSecurityGroup": {
  "Type": "AWS::EC2::SecurityGroup",
  "Properties": {
    "GroupDescription": "Seattle AWS Meetup Web Server Security Group",
    "VpcId": {
      "Ref": "AwsMeetupVpc"
    },
    "SecurityGroupIngress": [{
      "IpProtocol": "tcp",
      "FromPort": "22",
      "ToPort": "22",
      "SourceSecurityGroupId": {
        "Ref": "BastionSecurityGroup"
      }
    }, {
      "IpProtocol": "tcp",
      "FromPort": "80",
      "ToPort": "80",
      "SourceSecurityGroupId": {
        "Ref": "ElbSecurityGroup"
      }
    }, {
      "IpProtocol": "tcp",
      "FromPort": "1024",
      "ToPort": "65535",
      "SourceSecurityGroupId": {
        "Ref": "NatSecurityGroup"
      }
    }],
    "Tags": [{
      "Key": "Name",
      "Value": "Seattle AWS Meetup Web Server Security Group"
    }]
  }
},
